name: LearnJava

on:
  push:
    branches: [main]

jobs:
  build:
    environment: dev
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: '1.8'
        distribution: 'adopt'
        cache: maven
    - name: Build with Maven
      run: mvn clean install

    - name: List files in target directory
      run: ls target

    - name: Set up Docker
      run: |
        sudo apt-get update
        sudo apt-get install -y docker-compose

    - name: Hello world
      run: |
        touch .env
        echo DOCKER_HUB_ACCESS_TOKEN=${{ secrets.DOCKER_HUB_ACCESS_TOKEN }} >> .env
        echo DOCKER_HUB_ACCESS_USER=${{ secrets.DOCKER_HUB_ACCESS_USER }} >> .env
        echo MONGO_DB_URI=${{ secrets.MONGO_DB_URI }} >> .env
        echo MONGO_DB_NAME=${{ secrets.MONGO_DB_NAME }} >> .env

    - name: Login to DockerHub
      run: |
        echo "${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}" | docker login -u "${{ secrets.DOCKER_HUB_ACCESS_USER }}" --password-stdin
        
    - name: Build and Push DockerFile
      run: |
        docker-compose -f docker-compose.yaml build
        docker-compose -f docker-compose.yaml push

    - name: Stop and remove containers
      run: docker-compose -f docker-compose.yaml down

    - name: Deploy to VPS
      env:
        VPS_USER: root
        VPS_IP: ${{ secrets.VPS_IP }}
        VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }} 
      run: |
        sudo apt-get install -y sshpass
        
        sshpass -p $VPS_PASSWORD ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_IP "
        tmux attach-session -t 1 || tmux new-session -s 1
        cd server/
        docker compose down
        docker compose up -d --pull
        "

