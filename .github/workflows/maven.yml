name: LearnJava

on:
  push:
    branches: [main]
    paths-ignore:
      - README.md
      - docs/**


jobs:
  notify:
    runs-on: self-hosted

    steps:
    - name: Gửi thông báo đến Discord
      run: |
        curl -X POST -H "Content-Type: application/json" \
        -d '{"content": "```Phát hiện Pull Request trên nhánh main, đang tìm kiếm selfhost rảnh rỗi! ```"}' \
        https://discord.com/api/webhooks/1297132713119191121/B72OrNxwgv1-l5svlDvzUzIWLhtnlmnb4xoPH9BqoX6vG655uPK-vKirbAvmGIjHgt3R

  build:
    environment: dev
    runs-on: self-hosted
    steps:
    - uses: actions/checkout@v2
  
    - name: Thông Báo khởi động sv
      run: |
        curl -X POST -H "Content-Type: application/json" -d '{"content": "```Lưu ý server đang khởi động, không được call api cho tới khi có thông báo mới!```"}' https://discord.com/api/webhooks/1297132713119191121/B72OrNxwgv1-l5svlDvzUzIWLhtnlmnb4xoPH9BqoX6vG655uPK-vKirbAvmGIjHgt3R
    
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: '1.8'
        distribution: 'adopt'
        cache: maven
  
    - name: Build with Maven
      run: mvn clean install
        
    - name: Build and Push DockerFile
      run: |
        echo "${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}" | sudo docker login -u "${{ secrets.DOCKER_HUB_ACCESS_USER }}" --password-stdin
        sudo docker build -t lmao1415/dath_cnpm .
        sudo docker push lmao1415/dath_cnpm
  
    - name: Remove Docker Image
      run: |
        sudo docker rmi lmao1415/dath_cnpm

    - name: Deploy Trên server
      run: |
        sshpass -p ${{ secrets.VPS_PASSWORD }} ssh -o StrictHostKeyChecking=no root@${{ secrets.VPS_IP }} "
          cd server
          git pull
          > .env
          touch .env

          echo 'MONGO_DB_URI=${{ secrets.MONGO_DB_URI }}' >> .env 
          echo 'MONGO_DB_NAME=${{ secrets.MONGO_DB_NAME }}' >> .env 
          echo 'JWT_SECRET=${{ secrets.JWT_SECRET }}' >> .env 
          echo 'TELEGRAM_WEBHOOK_URL=${{ secrets.TELEGRAM_WEBHOOK_URL }}' >> .env 
          echo 'TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}' >> .env 
          echo 'TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}' >> .env 
          echo 'email=${{ secrets.EMAIL }}' >> .env 
          echo 'password_for_email=${{ secrets.password_for_email }}' >> .env 
          echo 'adminToken=${{ secrets.ADMINTOKEN }}' >> .env 

          
          echo 'y' | sudo docker container prune
          sudo docker rmi $(docker images -a -q) 2>dev>null || true  
          sudo docker compose down
          sudo docker compose pull

          tmux kill-session -t spring 2>/dev/null || true 
          tmux new-session -d -s spring 'sudo docker compose up'
        "
        
